function formOnLoad(executionContext) {
	checkAccountDeliveryPartner(executionContext);
	kycAlert(executionContext);
	addOnChange(executionContext);
}

//Registers functions that should run on change of fields
function addOnChange(executionContext) {
	var formContext = executionContext.getFormContext();
	formContext.getAttribute("parentaccountid").addOnChange(checkAccountDeliveryPartner);
}


// Shows a message if the account does not have delivery partner set to Yes
async function checkAccountDeliveryPartner(executionContext) {
	var formContext = executionContext.getFormContext();
	var accountid = formContext.getAttribute("parentaccountid").getValue()[0].id;
	var partyRole = await getAccountPartyRole(accountid);
	if (partyRole !== 968200000) {
		formContext.ui.setFormNotification("Account is not marked as Delivery Partner. Please update Account record and set Party Roles","INFO","100");
		}
	if (partyRole == 968200000) {
		formContext.ui.clearFormNotification("100");
		}
}

 async function getAccountPartyRole(accountid){
	var partyRoleValue = await Xrm.WebApi.online.retrieveRecord("account", `${accountid}`, "?$select=ukn_partyrole").then(
		function success(result) {
			var partyRole = result["ukn_partyrole"];
			return partyRole;
		},
		function(error) {
			Xrm.Utility.alertDialog(error.message);
		}
	);

	return partyRoleValue;
}

function kycAlert(executionContext) {
	var formContext         = executionContext.getFormContext();
	var kycStatus           = formContext.getAttribute("ukn_kycstatus").getValue();
	var oppStatus           = formContext.getAttribute("statecode").getValue();
    var originatingLead     = formContext.getAttribute("originatingleadid").getValue();
    //var iCApprovalStatus    = formContext.getAttribute("ukn_icboardapprovalrequiredyesno").getValue();
	var isThisTopup = formContext.getAttribute("ukn_topupexistingfacility").getValue();
	var alertStrings = { confirmButtonLabel: "OK", text: "No KYC has been submitted for this Opportunity.", title: "KYC Request" };
	var alertOptions = { height: 120, width: 260 };
	
	if (oppStatus == 0 && kycStatus !== 968200002 && kycStatus!== 968200003 && kycStatus!== 968200004) 
    {
		//Top up Existing Facility - 968200001 = No 
        if((originatingLead !== null && originatingLead !== "") || ((originatingLead === null || originatingLead === "") && isThisTopup === 968200001))
        {         
            Xrm.Navigation.openAlertDialog(alertStrings, alertOptions).then(
                function success(result) {
                    console.log("Alert dialog closed");
                },
                function (error) {
                    console.log(error.message);
                }
            );
    	}
    }    
}